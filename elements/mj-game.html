<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="base.html">
<link rel="import" href="mj-player.html">
<!--
<link rel="import" href="mj-win-modifiers.html">
<link rel="import" href="mj-scoring-area.html">
<link rel="import" href="mj-rules.html">
-->

<polymer-element name="mj-game" extends="mj-base" attributes="round windoftheround draws" round="-" draws="0" windoftheround="-">

  <template>
    <link rel="stylesheet" href="style/mj-ui.css">
    <link rel="stylesheet" href="style/mj-game.css">

    <div id="info">
      Hand: {{round}} ({{draws}} draws) <span id="wotr">Wind of the round: {{windoftheround}}</span>
    </div>
    <div id="players">
      <mj-player></mj-player>
      <mj-player></mj-player>
      <mj-player></mj-player>
      <mj-player></mj-player>
    </div>

<!--
    <div id="buttons">
      <button id="start">New Game</button>
      -
      <button id="reset" disabled>Reset this hand</button>
      -
      <button id="draw" disabled>Draw</button>
      -
      <button id="score" disabled>Score</button>
      with extras:
      <mj-win-modifiers id="extras"></mj-win-modifiers>
    </div>

    <mj-rules id="rules"></mj-rules>

    <mj-scoring-area id="scoring"></mj-scoring-area>
-->
  </template>

  <script>
    Polymer("mj-game", {
      ready: function() {
        this.rules = this.$.rules;
      },

      domReady: function() {
        var self = this;
/*
        this.players = this.find("mj-player");
        ["start", "reset",  "draw", "score"].forEach(function(n) {
          self.listen(self.$[n], "click", self[n].bind(self));
        });
        this.players.forEach(function(p) {
          p.useRules(self.rules);
        });
        this.$.scoring.bindPlayers(this.players);
        this.start();
*/
      },

      start: function(evt) {
        var self = this;
        this.players.forEach(function(p, idx) {
          p.reset(self.rules.base, idx, true);
        });
        this.players[0].markEast();
        self.$.start.disabled = true;
        self.$.reset.removeAttribute("disabled");
        self.$.draw.removeAttribute("disabled");
        self.$.score.removeAttribute("disabled");
        this.set("round", 1);
        this.set("windoftheround", 0);
        this.finished = false;
      },

      reset: function(evt) {
        this.players.forEach(function(p, idx) {
          p.reset();
        });
        this.$.extras.reset();
      },

      draw: function(evt) {
        this.reset();
        this.increment("draws");
        this.increment("round");
      },

      score: function(evt) {
        var self = this;
        var rules = self.rules;
        var players = self.players;
        var extras = self.$.extras.getExtras();
        var winner;

        // perform scoring
        var scores = players.map(function(p, idx) {
          var score = rules.score(p, self.get("windoftheround"), self.winds, extras);
          if (score.winner) { winner = p; winner.increment("wins"); }
          return score;
        });

        if(!winner) return alert("No one has won yet\n\n(Illegal win, Draw, or accidentally pressed Score?)");

        // award/dock points to/from players based on scores
        rules.award(players, scores);

        // set up the next hand
        var direction = rules.rotate(winner.get("wind"));
        if(winner && direction) {
          this.players.forEach(function(p) {
             p.nextWind(direction);
          });

          // advance the wind of the round
          if(this.players[0].get("wind") === 0) {
            this.increment("windoftheround");
          }

          // Game finished condition:
          if(this.get("windoftheround")>=4) {
            this.$.start.removeAttribute("disabled");
            this.$.reset.disabled = true;
            this.$.draw.disabled = true;
            this.$.score.disabled = true;
            this.finished = true;
          }
        }

        if(this.finished) {
          this.set("windoftheround", '-');
        } else {
          this.increment("round");
          this.reset();
        }
      }

    });
  </script>

</polymer-element>
